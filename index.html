<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>মা এন্টারপ্রাইজ - লেনদেন ম্যানেজম্যান্ট সিস্টেম</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --sidebar-bg: #0f172a; --primary: #3b82f6; --body-bg: #f1f5f9; }
        body { background-color: var(--body-bg); font-family: 'Hind Siliguri', sans-serif; overflow-x: hidden; padding-bottom: 75px; }
        
        /* Sidebar for Desktop */
        .sidebar { background: var(--sidebar-bg); min-height: 100vh; width: 250px; position: fixed; color: white; transition: 0.3s; z-index: 100; }
        .nav-link { color: #94a3b8; padding: 12px 20px; border-radius: 8px; margin: 5px 15px; cursor: pointer; display: block; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: var(--primary); color: white; }
        .main-content { margin-left: 250px; padding: 30px; transition: 0.3s; }

        /* Mobile Bottom Nav */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; border-top: 1px solid #ddd; }
        .mobile-nav .nav-item { flex: 1; text-align: center; padding: 10px 0; color: #64748b; text-decoration: none; font-size: 12px; cursor: pointer; }
        .mobile-nav .nav-item i { display: block; font-size: 20px; margin-bottom: 2px; }
        .mobile-nav .nav-item.active { color: var(--primary); }

        /* Cards */
        .stat-card { border: none; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); background: white; position: relative; }
        
        /* Utility */
        .hidden { display: none !important; }
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 15px; }
            .mobile-nav { display: flex; }
            .stat-card { margin-bottom: 10px; }
        }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary"></div></div>

<div id="login-screen">
    <div class="d-flex align-items-center justify-content-center" style="height: 100vh; background: #0f172a;">
        <div class="card p-4 shadow-lg" style="width: 380px; border-radius: 20px;">
            <div class="text-center mb-4">
                <div class="bg-primary d-inline-block p-3 rounded-circle mb-3"><i class="fas fa-store fa-2x text-white"></i></div>
                <h4 class="fw-bold">মা এন্টারপ্রাইজ</h4>
                <p class="text-muted small">লেনদেন ম্যানেজম্যান্ট সিস্টেম</p>
            </div>
            <input type="text" id="user" class="form-control mb-3" placeholder="ইউজারনেম">
            <input type="password" id="pass" class="form-control mb-3" placeholder="পাসওয়ার্ড">
            <button onclick="login()" class="btn btn-primary w-100 py-2 rounded-pill fw-bold">লগইন করুন</button>
        </div>
    </div>
</div>

<div id="main-app" class="hidden">
    <div class="sidebar shadow">
        <div class="p-4 text-center border-bottom border-secondary">
            <h4 class="fw-bold mb-0 text-white">মা এন্টারপ্রাইজ-লেনদেন ম্যানেজম্যান্ট সিস্টেম </h4>
        </div>
        <div class="mt-4">
            <a onclick="showSection('dashboard')" class="nav-link active" id="btn-dashboard"><i class="fas fa-home me-2"></i> ড্যাশবোর্ড</a>
            <a onclick="showSection('entry')" class="nav-link" id="btn-entry"><i class="fas fa-plus-circle me-2"></i> নতুন লেনদেন</a>
                        <a onclick="showSection('reports')" class="nav-link" id="btn-reports"><i class="fas fa-file-invoice-dollar me-2"></i> পার্টনার রিপোর্ট</a>
            <a onclick="showSection('partner-add')" class="nav-link" id="btn-partner-add"><i class="fas fa-user-plus me-2"></i> পার্টনার অ্যাড</a>
            <a onclick="showSection('collection')" class="nav-link" id="btn-collection"><i class="fas fa-hand-holding-usd me-2"></i> কালেকশন</a>
            <div class="mt-5 p-3"><button onclick="location.reload()" class="btn btn-outline-danger w-100 btn-sm">লগ আউট</button></div>
        </div>
    </div>

    <div class="mobile-nav">
        <a onclick="showSection('dashboard')" class="nav-item active" id="mbtn-dashboard"><i class="fas fa-home"></i>ড্যাশবোর্ড</a>
        <a onclick="showSection('entry')" class="nav-item" id="mbtn-entry"><i class="fas fa-plus-circle"></i>এন্ট্রি</a>
        <a onclick="showSection('collection')" class="nav-item" id="mbtn-collection"><i class="fas fa-hand-holding-usd"></i>কালেকশন</a>
        <a onclick="showSection('partner-add')" class="nav-item" id="mbtn-partner-add"><i class="fas fa-user-plus"></i>পার্টনার</a>
        <a onclick="showSection('reports')" class="nav-item" id="mbtn-reports"><i class="fas fa-file-alt"></i> রিপোর্ট</a>
    </div>

    <div class="main-content">
        <div id="section-dashboard">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold mb-0">ডেইলি সামারি</h3>
                <button onclick="refreshData()" class="btn btn-primary btn-sm rounded-pill px-3">
                    <i class="fas fa-sync-alt me-1"></i> রিফ্রেশ
                </button>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card border-start border-primary border-4">
                        <h6 class="text-muted small">আজকের পাঠানো</h6>
                        <h3 class="fw-bold text-primary">৳ <span id="dash-sent">০</span></h3>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-start border-success border-4">
                        <h6 class="text-muted small">আজকের জমা</h6>
                        <h3 class="fw-bold text-success">৳ <span id="dash-received">০</span></h3>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-start border-danger border-4">
                        <h6 class="text-muted small">নিট বকেয়া</h6>
                        <h3 class="fw-bold text-danger">৳ <span id="dash-due">০</span></h3>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card border-start border-warning border-4">
                        <h6 class="text-muted small">মেসেজ</h6>
                        <h3 class="fw-bold text-warning"><span id="dash-msg">০</span> টি</h3>
                    </div>
                </div>
            </div>
            
            <div class="stat-card mt-4">
                <h5 class="fw-bold mb-3">সাম্প্রতিক লেনদেনসমূহ</h5>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr><th>সময়</th><th>পার্টনার</th><th>পরিমাণ</th><th>ধরণ</th><th>অ্যাকশন</th></tr>
                        </thead>
                        <tbody id="recent-trans-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="section-entry" class="hidden">
            <h3 class="fw-bold mb-4">নতুন লেনদেন ও এন্ট্রি</h3>
            <div class="stat-card">
                <h5 class="fw-bold mb-3 text-primary"><i class="fas fa-paper-plane me-2"></i>টাকা পাঠানো/পাওনা এন্ট্রি</h5>
                <form id="transForm" class="row g-3">
                    <div class="col-md-6"><label class="fw-bold">পার্টনার নির্বাচন</label>
                        <select id="p_name" class="form-select" required></select>
                    </div>
                    <div class="col-md-3"><label class="fw-bold">মাধ্যম</label>
                        <select id="p_chan" class="form-select">
                            <option>বিকাশ</option><option>নগদ</option><option>রকেট</option><option>রিচার্জ</option><option>ব্যাংক/ক্যাশ</option>
                        </select>
                    </div>
                    <div class="col-md-3"><label class="fw-bold">টাইপ</label>
                        <select id="p_type" class="form-select">
                            <option value="Sent">পাঠিয়েছি (পাওনা)</option>
                        </select>
                    </div>
                    <div class="col-md-6"><label class="fw-bold">মোবাইল নম্বর / রেফারেন্স</label>
                        <input type="text" id="p_num" class="form-control" placeholder="017XXXXXXXX">
                    </div>
                    <div class="col-md-2"><label class="fw-bold">পরিমাণ (৳)</label>
                        <input type="number" id="p_amt" class="form-control" required>
                    </div>
                    <div class="col-md-2"><label class="fw-bold">পিন / লাস্ট ডিজিট</label>
                        <input type="text" id="p_pin" class="form-control">
                    </div>
                    <div class="col-md-2"><label class="fw-bold">মেসেজ সংখ্যা</label>
                        <input type="number" id="p_msg" class="form-control" value="1">
                    </div>
                    <div class="col-md-12 mt-4 text-end">
                        <button type="submit" id="saveBtn" class="btn btn-primary px-5 fw-bold">লেনদেন সেভ করুন</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="section-collection" class="hidden">
            <h3 class="fw-bold mb-4">পেমেন্ট কালেকশন (জমা)</h3>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="stat-card border-top border-success border-4">
                        <h5 class="fw-bold mb-3 text-success"><i class="fas fa-plus-circle me-2"></i>জমা এন্ট্রি ফর্ম</h5>
                        <form id="collectionForm">
                            <div class="mb-3">
                                <label class="fw-bold small">জমার তারিখ</label>
                                <input type="date" id="coll_date" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="fw-bold small">পার্টনার</label>
                                <select id="coll_p_name" class="form-select" required></select>
                            </div>
                            <div class="mb-3">
                                <label class="fw-bold small">জমার মাধ্যম</label>
                                <select id="coll_method" class="form-select">
                                    <option>ক্যাশ জমা</option>
                                    <option>ব্যাংক জমা</option>
                                    <option>মোবাইল ব্যাংকিং</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="fw-bold small">জমার পরিমাণ (৳)</label>
                                <input type="number" id="coll_amt" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100 fw-bold">কালেকশন সেভ করুন</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">জমার রিপোর্ট</h5>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><input type="date" id="coll_filter_date" class="form-control form-control-sm" onchange="filterCollectionTable()"></div>
                            <div class="col-6"><select id="coll_filter_partner" class="form-select form-select-sm" onchange="filterCollectionTable()"></select></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                    <tr><th>তারিখ</th><th>পার্টনার</th><th>মাধ্যম</th><th>পরিমাণ</th></tr>
                                </thead>
                                <tbody id="collection-history-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-partner-add" class="hidden">
            <h3 class="fw-bold mb-4">নতুন পার্টনার যুক্ত করুন</h3>
            <div class="stat-card mx-auto" style="max-width: 500px;">
                <form id="partnerForm">
                    <div class="mb-3"><label>পার্টনারের নাম</label><input type="text" id="np_name" class="form-control" required></div>
                    <div class="mb-3"><label>মোবাইল নম্বর (হোয়াটসঅ্যাপ)</label><input type="text" id="np_phone" class="form-control"></div>
                    <div class="mb-3"><label>শুরুর বকেয়া</label><input type="number" id="np_opening" class="form-control" value="0"></div>
                    <button type="submit" class="btn btn-success w-100 fw-bold">পার্টনার যুক্ত করুন</button>
                </form>
            </div>
        </div>

        <div id="section-reports" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <h3 class="fw-bold mb-0">পার্টনার লেনদেন রিপোর্ট</h3>
                <button onclick="downloadPDF()" class="btn btn-danger btn-sm"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>

            <div class="stat-card mb-4 bg-light">
                <div class="row g-2 align-items-end">
                    <div class="col-2"><button onclick="changeDate(-1)" class="btn btn-outline-primary btn-sm w-100 py-2"><i class="fas fa-arrow-left"></i></button></div>
                    <div class="col-8">
                        <label class="small fw-bold mb-1 text-primary">তারিখ নির্বাচন করুন</label>
                        <input type="date" id="filter_date" class="form-control" onchange="filterLedger()">
                    </div>
                    <div class="col-2"><button onclick="changeDate(1)" class="btn btn-outline-primary btn-sm w-100 py-2"><i class="fas fa-arrow-right"></i></button></div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card bg-primary text-white p-3">
                        <small>আজকের মোট পাঠানো </small>
                        <h4 class="fw-bold mb-0">৳ <span id="rep-total-sent">০</span></h4>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card bg-success text-white p-3">
                        <small>আজকের মোট জমা</small>
                        <h4 class="fw-bold mb-0">৳ <span id="rep-total-received">০</span></h4>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card bg-warning text-dark p-3">
                        <small>নিট বকেয়া</small>
                        <h4 class="fw-bold mb-0">৳ <span id="rep-net-due">০</span></h4>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div id="wa-btn-container" class="stat-card bg-dark text-white d-flex align-items-center justify-content-center p-3" style="cursor:pointer; height: 100%;">
                        <h6 class="mb-0 small"><i class="fab fa-whatsapp me-1 text-success"></i> WhatsApp সামারি</h6>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4 g-2">
                <div class="col-md-4">
                    <select id="report_p_name" class="form-select" onchange="filterLedger()">
                        <option value="">সকল পার্টনার</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <input type="text" id="searchInput" class="form-control" placeholder="বিবরণ দিয়ে খুঁজুন..." onkeyup="filterLedger()">
                </div>
            </div>

            <div class="stat-card p-0 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="ledger-table" style="font-size: 14px;">
                        <thead class="table-dark">
                            <tr><th>তারিখ ও সময়</th><th>পার্টনার</th><th>বিবরণ/নম্বর</th><th>পিন/লাস্ট ডিজিট</th><th>MSG</th><th>পাঠানো</th><th>অ্যাকশন</th></tr>
                        </thead>
                        <tbody id="ledger-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzR3k-hXrQEa7YlfsskDUYLUd3o9GqJ3SCgIVA2NFcCfX35IoPaUXiJK9G95vedjbIr0A/exec";
    let rawData = { partners: [], transactions: [] };

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filter_date').value = today;
        document.getElementById('coll_date').value = today;
    };

    function login() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(u === "admin" && p === "164416") {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            refreshData();
        } else {
            Swal.fire("ভুল!", "সঠিক ইউজার এবং পাসওয়ার্ড দিন", "error");
        }
    }

    async function refreshData() {
        const loader = document.getElementById('loader');
        if(loader) loader.style.display = 'flex';
        try {
            const response = await fetch(SCRIPT_URL + "?action=getInitialData");
            const data = await response.json();
            rawData = data;
            updatePartnerDropdowns();
            updateDashboard();
            updateLedgerTable();
            filterCollectionTable();
        } catch (e) {
            console.error("ডাটা লোড করতে সমস্যা হয়েছে:", e);
        } finally {
            if(loader) loader.style.display = 'none';
        }
    }

    async function apiCall(data) {
        const loader = document.getElementById('loader');
        if(loader) loader.style.display = 'flex';
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            return true;
        } catch (e) { return false; } 
        finally { if(loader) loader.style.display = 'none'; }
    }

    function showSection(id) {
        ['dashboard', 'entry', 'collection', 'partner-add', 'reports'].forEach(s => {
            const sec = document.getElementById('section-'+s);
            const btn = document.getElementById('btn-'+s);
            const mbtn = document.getElementById('mbtn-'+s);
            if(sec) sec.classList.add('hidden');
            if(btn) btn.classList.remove('active');
            if(mbtn) mbtn.classList.remove('active');
        });
        const targetSec = document.getElementById('section-'+id);
        const targetBtn = document.getElementById('btn-'+id);
        const targetMBtn = document.getElementById('mbtn-'+id);
        if(targetSec) targetSec.classList.remove('hidden');
        if(targetBtn) targetBtn.classList.add('active');
        if(targetMBtn) targetMBtn.classList.add('active');
        if(id === 'dashboard' || id === 'reports' || id === 'collection') refreshData();
    }

    function changeDate(days) {
        const dateInput = document.getElementById('filter_date');
        let current = new Date(dateInput.value);
        current.setDate(current.getDate() + days);
        dateInput.value = current.toISOString().split('T')[0];
        filterLedger();
    }

    function updatePartnerDropdowns() {
        const pSelect = document.getElementById('p_name');
        const cSelect = document.getElementById('coll_p_name');
        const rSelect = document.getElementById('report_p_name');
        const cfSelect = document.getElementById('coll_filter_partner');
        let options = '<option value="">বাছাই করুন</option>';
        if(rawData.partners) {
            rawData.partners.forEach(p => { options += `<option value="${p[1]}">${p[1]}</option>`; });
        }
        if(pSelect) pSelect.innerHTML = options;
        if(cSelect) cSelect.innerHTML = options;
        if(rSelect) rSelect.innerHTML = options;
        if(cfSelect) cfSelect.innerHTML = '<option value="">সকল পার্টনার</option>' + options;
    }

    function updateDashboard() {
        let sentToday = 0, receivedToday = 0, totalDue = 0, totalMsgs = 0;
        const todayStr = new Date().toLocaleDateString('en-GB').split('/').join('-');
        if(rawData.transactions) {
            rawData.transactions.forEach(t => {
                if(t[0] && t[0].includes(todayStr)) {
                    sentToday += Number(t[2]) || 0;
                    receivedToday += Number(t[3]) || 0;
                    totalMsgs += Number(t[4]) || 0;
                }
            });
        }
        if(rawData.partners) {
            rawData.partners.forEach(p => { totalDue += Number(p[4]) || 0; });
        }
        document.getElementById('dash-sent').innerText = sentToday.toLocaleString('bn-BD');
        document.getElementById('dash-received').innerText = receivedToday.toLocaleString('bn-BD');
        document.getElementById('dash-due').innerText = totalDue.toLocaleString('bn-BD');
        document.getElementById('dash-msg').innerText = totalMsgs;

        const recentBody = document.getElementById('recent-trans-body');
        if(recentBody && rawData.transactions) {
            recentBody.innerHTML = rawData.transactions.slice(0, 8).map(t => {
                const sVal = Number(t[2]) || 0;
                const rVal = Number(t[3]) || 0;
                const amt = sVal > 0 ? sVal : rVal;
                return `<tr><td>${t[0].split(' ')[1] || t[0]}</td><td>${t[1]}</td><td>৳${amt}</td><td><span class="badge ${sVal > 0 ? 'bg-primary' : 'bg-success'}">${sVal > 0 ? 'পাঠানো' : 'জমা'}</span></td><td><button class="btn btn-sm btn-light" onclick="showSection('reports')">Detail</button></td></tr>`;
            }).join('');
        }
    }

    function updateLedgerTable() {
        const tbody = document.getElementById('ledger-body');
        if(tbody && rawData.transactions) {
            tbody.innerHTML = rawData.transactions.map((t, index) => {
                const sVal = Number(t[2]) || 0;
                const rVal = Number(t[3]) || 0;
                if(rVal > 0) return ''; // শুধুমাত্র পাঠানোগুলো দেখাবে
                return `<tr id="row-${index}">
                    <td>${t[0]}</td>
                    <td>${t[1]}</td>
                    <td>${t[5] || '-'}</td>
                    <td class="fw-bold">${t[6] || '-'}</td>
                    <td>${t[4] || '0'}</td>
                    <td class="text-primary fw-bold">৳${sVal}</td>
                    <td><button onclick="editEntry(${index})" class="btn btn-sm btn-outline-warning"><i class="fas fa-edit"></i></button></td>
                </tr>`;
            }).join('');
        }
        filterLedger();
    }

    function filterLedger() {
        const pFilter = document.getElementById('report_p_name').value;
        const sFilter = document.getElementById('searchInput').value.toLowerCase();
        const dateFilter = document.getElementById('filter_date').value;
        let formattedDate = "";
        if(dateFilter) {
            const parts = dateFilter.split('-');
            formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        let tSent = 0, tReceived = 0, netDue = 0;
        if(rawData.transactions) {
            rawData.transactions.forEach((t, index) => {
                const rowEl = document.getElementById(`row-${index}`);
                const matchesDate = formattedDate === "" || t[0].includes(formattedDate);
                const matchesPartner = pFilter === "" || t[1] === pFilter;
                const matchesSearch = (t[1] + (t[5]||'')).toLowerCase().includes(sFilter);
                if (matchesDate && matchesPartner && matchesSearch) {
                    if(rowEl) rowEl.style.display = "";
                    tSent += Number(t[2]) || 0;
                    tReceived += Number(t[3]) || 0;
                } else {
                    if(rowEl) rowEl.style.display = "none";
                }
            });
        }
        if(pFilter !== "") {
            const pData = rawData.partners.find(p => p[1] === pFilter);
            netDue = pData ? Number(pData[4]) : 0;
        } else if(rawData.partners) {
            rawData.partners.forEach(p => { netDue += Number(p[4]) || 0; });
        }
        document.getElementById('rep-total-sent').innerText = tSent.toLocaleString('bn-BD');
        document.getElementById('rep-total-received').innerText = tReceived.toLocaleString('bn-BD');
        document.getElementById('rep-net-due').innerText = netDue.toLocaleString('bn-BD');

        const waContainer = document.getElementById('wa-btn-container');
        if(waContainer) {
            waContainer.onclick = pFilter ? () => sendDaySummary(pFilter, formattedDate) : () => Swal.fire("পার্টনার সিলেক্ট করুন!");
        }
    }

    function filterCollectionTable() {
        const pFilter = document.getElementById('coll_filter_partner').value;
        const dFilter = document.getElementById('coll_filter_date').value;
        const tbody = document.getElementById('collection-history-body');
        
        let formattedDate = "";
        if(dFilter) {
            const parts = dFilter.split('-');
            formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        if(tbody && rawData.transactions) {
            tbody.innerHTML = rawData.transactions
            .filter(t => Number(t[3]) > 0)
            .filter(t => pFilter === "" || t[1] === pFilter)
            .filter(t => formattedDate === "" || t[0].includes(formattedDate))
            .map(t => `<tr><td>${t[0].split(' ')[0]}</td><td>${t[1]}</td><td>${t[6] || 'জমা'}</td><td class="text-success fw-bold">৳${t[3]}</td></tr>`)
            .join('');
        }
    }

    function sendDaySummary(name, dateStr) {
        const partner = rawData.partners.find(p => p[1] === name);
        if(!partner) return;
        let daySent = 0, dayReceived = 0;
        rawData.transactions.forEach(t => {
            if(t[1] === name && t[0].includes(dateStr)) {
                daySent += Number(t[2]) || 0;
                dayReceived += Number(t[3]) || 0;
            }
        });
        const due = document.getElementById('rep-net-due').innerText;
        const msg = `*দৈনিক লেনদেন সামারি*\nতারিখ: ${dateStr}\nপার্টনার: ${name}\n----------------------\nআজকের পাঠানো: ৳${daySent}\nআজকের জমা: ৳${dayReceived}\n----------------------\n*বর্তমান নিট বকেয়া: ৳${due}*\nধন্যবাদ।\n- মা এন্টারপ্রাইজ`;
        window.open(`https://wa.me/88${partner[2]}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function editEntry(index) {
        const t = rawData.transactions[index];
        const { value: formValues } = await Swal.fire({
            title: 'এডিট করুন',
            html: `<input id="swal-amt" class="swal2-input" value="${t[2]}"><input id="swal-desc" class="swal2-input" value="${t[5] || ''}">`,
            showCancelButton: true,
            confirmButtonText: 'আপডেট',
            preConfirm: () => { return { amount: document.getElementById('swal-amt').value, desc: document.getElementById('swal-desc').value } }
        });
        if (formValues) {
            const data = { action: "editTransaction", index: index, amount: formValues.amount, desc: formValues.desc, type: "Sent" };
            if(await apiCall(data)) { Swal.fire("সফল!", "আপডেট হয়েছে", "success"); refreshData(); }
        }
    }

    document.getElementById('transForm').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            action: "addTransaction", partnerName: document.getElementById('p_name').value,
            channel: document.getElementById('p_chan').value, type: "Sent",
            number: document.getElementById('p_num').value, amount: document.getElementById('p_amt').value,
            lastDigit: document.getElementById('p_pin').value, msgCount: document.getElementById('p_msg').value
        };
        if(await apiCall(data)) { Swal.fire("সফল!", "লেনদেন সেভ হয়েছে", "success"); this.reset(); refreshData(); }
    };

    document.getElementById('collectionForm').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            action: "addTransaction", partnerName: document.getElementById('coll_p_name').value,
            channel: "Collection", type: "Received", number: "Collection",
            amount: document.getElementById('coll_amt').value, lastDigit: document.getElementById('coll_method').value,
            msgCount: 0, date: document.getElementById('coll_date').value
        };
        if(await apiCall(data)) { Swal.fire("সফল!", "কালেকশন সেভ হয়েছে", "success"); this.reset(); refreshData(); }
    };

    document.getElementById('partnerForm').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            action: "addPartner", name: document.getElementById('np_name').value,
            phone: document.getElementById('np_phone').value, opening: document.getElementById('np_opening').value
        };
        if(await apiCall(data)) { Swal.fire("সফল!", "পার্টনার যুক্ত হয়েছে", "success"); this.reset(); refreshData(); }
    };

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.text("Ma Enterprise - Transaction Ledger Report", 14, 15);
        doc.autoTable({ html: '#ledger-table', theme: 'grid', startY: 20 });
        doc.save("Ma_Enterprise_Report.pdf");
    }
</script>
</body>
</html>
